name: aliyun-acr-build-deploy

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: aliyun-acr-build-deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  ACR_REGISTRY: ${{ secrets.ALIYUN_ACR_REGISTRY }}
  ACR_NAMESPACE: ${{ secrets.ALIYUN_ACR_NAMESPACE }}

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - component: agents
            context: agents
            image: sparkplay-agents
            dockerfile: agents/Dockerfile
          - component: service
            context: service
            image: sparkplay-service
            dockerfile: service/Dockerfile
          - component: web
            context: web
            image: sparkplay-web
            dockerfile: web/Dockerfile
          - component: web-api
            context: .
            image: sparkplay-web-api
            dockerfile: web_api/Dockerfile
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          ssh-key: ${{ secrets.GH_SUBMODULES_SSH_PRIVATE_KEY }}

      - uses: docker/setup-buildx-action@v3
      - name: Normalize ACR registry
        shell: bash
        run: |
          set -euo pipefail
          ACR_REGISTRY_CLEAN="${ACR_REGISTRY#http://}"
          ACR_REGISTRY_CLEAN="${ACR_REGISTRY_CLEAN#https://}"
          ACR_REGISTRY_CLEAN="${ACR_REGISTRY_CLEAN%/}"
          echo "ACR_REGISTRY=${ACR_REGISTRY_CLEAN}" >> "$GITHUB_ENV"

      - name: Login ACR
        shell: bash
        env:
          ACR_USERNAME: ${{ secrets.ALIYUN_ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ALIYUN_ACR_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "${ACR_REGISTRY:-}" ] || [ -z "${ACR_NAMESPACE:-}" ] || [ -z "${ACR_USERNAME:-}" ] || [ -z "${ACR_PASSWORD:-}" ]; then
            echo "Missing required secrets: ALIYUN_ACR_REGISTRY, ALIYUN_ACR_NAMESPACE, ALIYUN_ACR_USERNAME, ALIYUN_ACR_PASSWORD" >&2
            exit 1
          fi
          printf '%s' "${ACR_PASSWORD}" | docker login "${ACR_REGISTRY}" -u "${ACR_USERNAME}" --password-stdin

      - name: Mirror mysql image
        if: matrix.component == 'web'
        shell: bash
        run: |
          set -euo pipefail
          docker pull mysql:8.4
          docker tag mysql:8.4 "${ACR_REGISTRY}/${ACR_NAMESPACE}/mysql:8.4"
          docker push "${ACR_REGISTRY}/${ACR_NAMESPACE}/mysql:8.4"

      - name: Check Dockerfile
        id: check
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "${{ matrix.dockerfile }}" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push
        if: steps.check.outputs.exists == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: true
          build-args: |
            COMMIT_SHA=${{ github.sha }}
          tags: |
            ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ matrix.image }}:latest
            ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ matrix.image }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ALIYUN_DEPLOY_SSH_PRIVATE_KEY }}

      - name: Add known hosts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.ALIYUN_DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy
        shell: bash
        env:
          DEPLOY_HOST: ${{ secrets.ALIYUN_DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.ALIYUN_DEPLOY_USER }}
          DEPLOY_DIR: ${{ secrets.ALIYUN_DEPLOY_DIR }}
          ACR_USERNAME: ${{ secrets.ALIYUN_ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ALIYUN_ACR_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "${ACR_REGISTRY:-}" ] || [ -z "${ACR_NAMESPACE:-}" ] || [ -z "${ACR_USERNAME:-}" ] || [ -z "${ACR_PASSWORD:-}" ]; then
            echo "Missing required secrets: ALIYUN_ACR_REGISTRY, ALIYUN_ACR_NAMESPACE, ALIYUN_ACR_USERNAME, ALIYUN_ACR_PASSWORD" >&2
            exit 1
          fi
          if [ -z "${DEPLOY_HOST:-}" ] || [ -z "${DEPLOY_USER:-}" ]; then
            echo "Missing required secrets: ALIYUN_DEPLOY_HOST, ALIYUN_DEPLOY_USER" >&2
            exit 1
          fi

          ACR_REGISTRY_CLEAN="${ACR_REGISTRY#http://}"
          ACR_REGISTRY_CLEAN="${ACR_REGISTRY_CLEAN#https://}"
          ACR_REGISTRY_CLEAN="${ACR_REGISTRY_CLEAN%/}"

          REMOTE_DIR="${DEPLOY_DIR:-sparkx}"
          ssh "${DEPLOY_USER}@${DEPLOY_HOST}" "mkdir -p \"${REMOTE_DIR}\""
          scp ./deploy/docker-compose.yml "${DEPLOY_USER}@${DEPLOY_HOST}:${REMOTE_DIR}/docker-compose.yml"

          ssh "${DEPLOY_USER}@${DEPLOY_HOST}" "bash -s" <<EOF
          set -euo pipefail
          cd "${REMOTE_DIR}"
          if [ ! -f docker-compose.yml ] && [ ! -f docker-compose.yaml ] && [ ! -f compose.yml ] && [ ! -f compose.yaml ]; then
            echo "No compose file found in remote dir: ${REMOTE_DIR}" >&2
            exit 1
          fi
          export ACR_REGISTRY="${ACR_REGISTRY_CLEAN}"
          export ACR_NAMESPACE="${ACR_NAMESPACE}"
          export MYSQL_IMAGE="${ACR_REGISTRY}/${ACR_NAMESPACE}/mysql:8.4"

          DOCKER_CONFIG_DIR="$(mktemp -d)"
          export DOCKER_CONFIG="\${DOCKER_CONFIG_DIR}"
          trap 'rm -rf "\${DOCKER_CONFIG_DIR}"' EXIT
          printf '%s' "${ACR_PASSWORD}" | docker login "${ACR_REGISTRY}" -u "${ACR_USERNAME}" --password-stdin
          if docker compose version >/dev/null 2>&1; then
            docker compose pull
            docker compose up -d --remove-orphans
          elif command -v docker-compose >/dev/null 2>&1; then
            docker-compose pull
            docker-compose up -d --remove-orphans
          else
            echo "Neither docker compose nor docker-compose is available on remote host" >&2
            exit 1
          fi
          EOF
