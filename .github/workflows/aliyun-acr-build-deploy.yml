name: aliyun-acr-build-deploy

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: aliyun-acr-build-deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  ACR_REGISTRY: ${{ secrets.ALIYUN_ACR_REGISTRY }}
  ACR_NAMESPACE: ${{ secrets.ALIYUN_ACR_NAMESPACE }}

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - component: agents
            context: agents
            image: sparkplay-agents
          - component: service
            context: service
            image: sparkplay-service
          - component: web
            context: web
            image: sparkplay-web
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          ssh-key: ${{ secrets.GH_SUBMODULES_SSH_PRIVATE_KEY }}

      - uses: docker/setup-buildx-action@v3

      - name: Login ACR
        shell: bash
        env:
          ACR_USERNAME: ${{ secrets.ALIYUN_ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ALIYUN_ACR_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "${ACR_REGISTRY:-}" ] || [ -z "${ACR_NAMESPACE:-}" ] || [ -z "${ACR_USERNAME:-}" ] || [ -z "${ACR_PASSWORD:-}" ]; then
            echo "Missing required secrets: ALIYUN_ACR_REGISTRY, ALIYUN_ACR_NAMESPACE, ALIYUN_ACR_USERNAME, ALIYUN_ACR_PASSWORD" >&2
            exit 1
          fi
          printf '%s' "${ACR_PASSWORD}" | docker login "${ACR_REGISTRY}" -u "${ACR_USERNAME}" --password-stdin

      - name: Check Dockerfile
        id: check
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "${{ matrix.context }}/Dockerfile" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push
        if: steps.check.outputs.exists == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.context }}/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ matrix.image }}:latest
            ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ matrix.image }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ALIYUN_DEPLOY_SSH_PRIVATE_KEY }}

      - name: Add known hosts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.ALIYUN_DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      - name: Test SSH connection
        shell: bash
        run: |
          set -e
          ssh -vvv "${{ secrets.ALIYUN_DEPLOY_USER }}@${{ secrets.ALIYUN_DEPLOY_HOST }}" "whoami && hostname"

      - name: Deploy
        shell: bash
        env:
          DEPLOY_HOST: ${{ secrets.ALIYUN_DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.ALIYUN_DEPLOY_USER }}
          DEPLOY_DIR: ${{ secrets.ALIYUN_DEPLOY_DIR }}
          ACR_USERNAME: ${{ secrets.ALIYUN_ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ALIYUN_ACR_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "${ACR_REGISTRY:-}" ] || [ -z "${ACR_NAMESPACE:-}" ] || [ -z "${ACR_USERNAME:-}" ] || [ -z "${ACR_PASSWORD:-}" ]; then
            echo "Missing required secrets: ALIYUN_ACR_REGISTRY, ALIYUN_ACR_NAMESPACE, ALIYUN_ACR_USERNAME, ALIYUN_ACR_PASSWORD" >&2
            exit 1
          fi
          if [ -z "${DEPLOY_HOST:-}" ] || [ -z "${DEPLOY_USER:-}" ] || [ -z "${DEPLOY_DIR:-}" ]; then
            echo "Missing required secrets: ALIYUN_DEPLOY_HOST, ALIYUN_DEPLOY_USER, ALIYUN_DEPLOY_DIR" >&2
            exit 1
          fi
          ssh "${DEPLOY_USER}@${DEPLOY_HOST}" "bash -s" <<EOF
          set -euo pipefail
          if [ ! -d "${DEPLOY_DIR}" ]; then
            echo "DEPLOY_DIR does not exist: ${DEPLOY_DIR}" >&2
            exit 1
          fi
          cd "${DEPLOY_DIR}"
          if [ ! -f docker-compose.yml ] && [ ! -f docker-compose.yaml ] && [ ! -f compose.yml ] && [ ! -f compose.yaml ]; then
            echo "No compose file found in DEPLOY_DIR: ${DEPLOY_DIR}" >&2
            exit 1
          fi

          DOCKER_CONFIG_DIR="$(mktemp -d)"
          export DOCKER_CONFIG="\${DOCKER_CONFIG_DIR}"
          trap 'rm -rf "\${DOCKER_CONFIG_DIR}"' EXIT
          printf '%s' "${ACR_PASSWORD}" | docker login "${ACR_REGISTRY}" -u "${ACR_USERNAME}" --password-stdin
          if command -v docker-compose >/dev/null 2>&1; then
            docker-compose pull
            docker-compose up -d --remove-orphans
          else
            docker compose pull
            docker compose up -d --remove-orphans
          fi
          EOF
